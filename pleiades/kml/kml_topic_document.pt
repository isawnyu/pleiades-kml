<?xml version="1.0" encoding="utf-8"?>
<kml
  xmlns="http://www.opengis.net/kml/2.2"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  i18n:domain="plone"
  tal:define="kml_macros context/@@kml_macros/macros | macros/kml_macros/macros;
              main_macros context/@@kml_template/macros | macros/kml_template/macros"
  >

  <metal:m metal:use-macro="main_macros/doc">
  
  <Document>

  <metal:s metal:fill-slot="document_styles">
    <metal:m metal:use-macro="kml_macros/core_style"/>
    <metal:m metal:use-macro="kml_macros/peripheral_style"/>
  </metal:s>

  <metal:s metal:fill-slot="document_contents">

  <tal:placemarks tal:repeat="pm view/features">

    <!-- precisely located placemarks first -->
    <tal:is_precise
      condition="not:pm/objects|nothing">
    <tal:pm_defs
      define="pm_name pm/name;
              pm_alternate_link pm/alternate_link;
              pm_author pm/author;
              pm_snippet pm/snippet;
              pm_description pm/description;
              pm_tags pm/tags;
              pm_ftypes pm/featureTypes;
              pm_tperiods pm/timePeriods;
              pm_timeSpan pm/timeSpan;
              styleName request/form/style | string:core;
              pm_styleUrl string:#${styleName}Style;"
      >
      <metal:m metal:use-macro="kml_macros/placemark">
      <metal:s metal:fill-slot="placemark_content">
      <description>
        <span tal:replace="structure string:&lt;![CDATA[" />
          <p><em tal:content="pm_description">ITEM DESCRIPTION</em></p>
          <ul><!-- Attributes -->
          <li>Tags: <span tal:content="pm_tags">TAGS</span></li>
          <li>Feature types: <span tal:content="pm_ftypes">TYPES</span></li>
          <li>Time periods: <span tal:content="pm_tperiods">PERIODS</span></li>
          </ul>
        <span tal:replace="structure string:]]&gt;" />
      </description>
      </metal:s>
      </metal:m>
    </tal:pm_defs>
    </tal:is_precise>

    <!-- roughly located placemarks next -->
    <tal:is_rough
      condition="pm/objects|nothing">
    <tal:pm_defs
      define="pm_name pm/name; 
              pm_alternate_link pm/alternate_link;
              pm_author pm/author;
              pm_snippet pm/snippet;
              pm_description pm/description;
              styleName request/form/style | string:peripheral;
              pm_styleUrl string:#${styleName}Style;
              objects pm/objects;
              numObjects python:len(objects)"
      >
      <metal:m use-macro="kml_macros/placemark">
      <metal:s metal:fill-slot="placemark_content">
      <description>
        <span tal:replace="structure string:&lt;![CDATA[" />
          <div>
            <p>This <span tal:content="pm_description">DESCR</span>
            contains <span tal:content="numObjects">N</span>
            imprecisely located place(s): </p>
            <ul>
              <li tal:repeat="obj objects">
              <a
                style="color: #2575AD; text-decoration: underline"
                tal:attributes="href obj/alternate_link" 
                tal:content="obj/name"
                >ITEM URL
              </a> <em>(<span tal:content="obj/featureTypes">TYPES</span>; <span tal:content="obj/timePeriods">PERIODS</span>)</em>: <span tal:content="obj/altLocation|nothing">Alt Location</span>
              </li>
            </ul>
          </div>
        <span tal:replace="structure string:]]&gt;" />
      </description>
      </metal:s>
      </metal:m>
    </tal:pm_defs>
    </tal:is_rough>

    </tal:placemarks>
    
    </metal:s>

  </Document>

  </metal:m>

</kml>
